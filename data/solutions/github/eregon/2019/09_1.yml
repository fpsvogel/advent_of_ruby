---
- :name: 9a.rb
  :url: https://github.com/eregon/adventofcode/blob/master/2019
  :solution: "input = File.read('9.txt')\ncode = input.chomp.split(',').map { |e| Integer(e) }.freeze\n\ndef interpreter(memory, inputs)\n  memory = memory.dup\n  def memory.[](i)\n    raise if i < 0\n    super(i) || 0\n  end\n  ip = 0\n  mode = 0\n  relative_base = 0\n\n  get_mode = -> i {\n    mode / (10 ** (i-1)) % 10\n  }\n\n  read = -> i {\n    v = memory[ip + i]\n    case m = get_mode[i]\n    when 0 # position\n      memory[v]\n    when 1 # immediate\n      v\n    when 2 # relative\n      memory[relative_base + v]\n    else\n      raise \"Unknown read mode #{m} (#{mode} #{i})\"\n    end\n  }\n  \n  write = -> i, result {\n    v = memory[ip + i]\n    case m = get_mode[i]\n    when 0 # position\n      memory[v] = result\n    when 2 # relative\n      memory[relative_base + v] = result\n    else\n      raise \"Unknown write mode #{m} (#{mode} #{i})\"\n    end\n  }\n\n  result = nil\n  while true\n    instruction = memory[ip]\n    mode, opcode = instruction.divmod(100)\n    case opcode\n    when 1 # add\n      write[3, read[1] + read[2]]\n      ip += 4\n    when 2 # multiply\n      write[3, read[1] * read[2]]\n      ip += 4\n    when 3 # input\n      input = inputs.shift || raise\n      write[1, input]\n      ip += 2\n    when 4 # output\n      result = read[1]\n      puts \"Output: #{result}\"\n      ip += 2\n    when 5 # jump-if-true\n      if read[1] != 0\n        ip = read[2]\n      else\n        ip += 3\n      end\n    when 6 # jump-if-false\n      if read[1] == 0\n        ip = read[2]\n      else\n        ip += 3\n      end\n    when 7 # less than\n      write[3, read[1] < read[2] ? 1 : 0]\n      ip += 4\n    when 8 # equals\n      write[3, read[1] == read[2] ? 1 : 0]\n      ip += 4\n    when 9 # relative base offset\n      relative_base += read[1]\n      ip += 2\n    when 99\n      break\n    else\n      raise \"Unknown opcode: #{opcode} at #{ip} (#{instruction})\"\n    end\n  end\n  result\nend\n\np interpreter(code, [1])"
